<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskManager - Управление пользователями</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .user-card {
            transition: all 0.3s ease;
            border-left: 4px solid #007bff;
        }
        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .role-admin { border-left-color: #dc3545; }
        .role-manager { border-left-color: #ffc107; }
        .role-executor { border-left-color: #28a745; }
        .user-actions {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .user-card:hover .user-actions {
            opacity: 1;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="/">
            <i class="fas fa-tasks me-2"></i>TaskManager
        </a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link text-white" href="/dashboard">
                <i class="fas fa-tachometer-alt me-1"></i>Панель управления
            </a>
            <a class="nav-link text-white" href="/tasks">
                <i class="fas fa-list-check me-1"></i>Задачи
            </a>
            <!-- Скрываем Проекты для исполнителя -->
            <a class="nav-link text-white" href="/projects"
               th:if="${#authentication != null && (#authentication.principal.role != 'EXECUTOR')}">
                <i class="fas fa-folder me-1"></i>Проекты
            </a>
            <!-- Скрываем Пользователи для не-администраторов -->
            <a class="nav-link text-white" href="/admin/users"
               th:if="${#authentication != null && (#authentication.principal.role == 'ADMIN')}">
                <i class="fas fa-users me-1"></i>Пользователи
            </a>
            <a class="nav-link text-white" href="/api/tasks" target="_blank">
                <i class="fas fa-code me-1"></i>API
            </a>
            <div class="nav-item dropdown">
                <a class="nav-link text-white dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                    <i class="fas fa-user me-1"></i>
                    <span th:text="${#authentication.name}">Пользователь</span>
                </a>
                <ul class="dropdown-menu">
                    <li><span class="dropdown-item-text">
                        Пользователь: <strong><span th:text="${#authentication.name}">Имя</span></strong>
                    </span></li>
                    <li><span class="dropdown-item-text">
                        Роль: <strong><span th:text="${#authentication.principal.role}">Роль</span></strong>
                    </span></li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <form th:action="@{/logout}" method="post" class="d-inline">
                            <button type="submit" class="dropdown-item">
                                <i class="fas fa-sign-out-alt me-2"></i>Выйти
                            </button>
                        </form>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <!-- Заголовок и статистика -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="fas fa-users me-2"></i>Управление пользователями</h2>
            <p class="text-muted">Всего пользователей: <span th:text="${usersCount}">0</span></p>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-primary" onclick="showCreateUserForm()">
                <i class="fas fa-plus me-1"></i>Создать пользователя
            </button>
        </div>
    </div>

    <!-- Список пользователей -->
    <div class="row">
        <div th:each="user : ${users}" class="col-md-6 col-lg-4 mb-4">
            <div class="card user-card h-100"
                 th:classappend="${user.role.name() == 'ADMIN'} ? 'role-admin' :
                                 (${user.role.name() == 'MANAGER'} ? 'role-manager' : 'role-executor')">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="card-title mb-0" th:text="${user.username}">Имя пользователя</h5>
                        <div class="user-actions">
                            <button class="btn btn-sm btn-outline-primary me-1" th:attr="data-user-id=${user.id}" onclick="editUserFromButton(this)">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" th:attr="data-user-id=${user.id}, data-username=${user.username}" onclick="confirmDeleteUserFromButton(this)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>

                    <p class="card-text text-muted" th:text="${user.fullName}">Полное имя</p>

                    <div class="user-meta mb-3">
                        <div class="mb-1">
                            <small class="text-muted">
                                <i class="fas fa-envelope me-1"></i>
                                <span th:text="${user.email}">Email</span>
                            </small>
                        </div>
                        <div class="mb-1">
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i>
                                Создан: <span th:text="${#temporals.format(user.createdAt, 'dd.MM.yyyy')}">дата</span>
                            </small>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge"
                              th:classappend="${user.role.name() == 'ADMIN'} ? 'bg-danger' :
                                              (${user.role.name() == 'MANAGER'} ? 'bg-warning' : 'bg-success')"
                              th:text="${user.role.name() == 'ADMIN'} ? 'Администратор' :
                                       (${user.role.name() == 'MANAGER'} ? 'Менеджер' : 'Исполнитель')">
                            Роль
                        </span>
                        <small class="text-muted">
                            ID: <span th:text="${user.id}">0</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Сообщение если пользователей нет -->
    <div th:if="${usersCount == 0}" class="text-center py-5">
        <i class="fas fa-users fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">Пользователи не найдены</h4>
        <p class="text-muted">Создайте первого пользователя, нажав на кнопку "Создать пользователя"</p>
    </div>
</div>

<!-- Модальное окно для создания/редактирования пользователя -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalTitle">Создание нового пользователя</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId" name="id">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="userUsername" class="form-label">Имя пользователя *</label>
                                <input type="text" class="form-control" id="userUsername" name="username" required
                                       placeholder="Введите имя пользователя">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="userRole" class="form-label">Роль *</label>
                                <select class="form-select" id="userRole" name="role" required>
                                    <option value="EXECUTOR">Исполнитель</option>
                                    <option value="MANAGER">Менеджер</option>
                                    <option value="ADMIN">Администратор</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="userFullName" class="form-label">Полное имя *</label>
                        <input type="text" class="form-control" id="userFullName" name="fullName" required
                               placeholder="Введите полное имя">
                    </div>

                    <div class="mb-3">
                        <label for="userEmail" class="form-label">Email *</label>
                        <input type="email" class="form-control" id="userEmail" name="email" required
                               placeholder="Введите email">
                    </div>

                    <div class="mb-3">
                        <label for="userPassword" class="form-label" id="userPasswordLabel">Пароль *</label>
                        <input type="password" class="form-control" id="userPassword" name="password"
                               placeholder="Введите пароль">
                        <div class="form-text" id="passwordHelp" style="display: none;">Для существующих пользователей: оставьте пустым, чтобы не менять пароль</div>
                    </div>

                    <div class="alert alert-info">
                        <small>
                            <i class="fas fa-info-circle me-1"></i>
                            Пароль будет зашифрован перед сохранением в базе данных.
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" id="deleteUserBtn" style="display: none;" onclick="deleteUser()">Удалить пользователя</button>
                <button type="button" class="btn btn-primary" onclick="saveUser()">Сохранить пользователя</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentUserId = null;
    const userModal = new bootstrap.Modal(document.getElementById('userModal'));

    function showCreateUserForm() {
        currentUserId = null;
        document.getElementById('userModalTitle').textContent = 'Создание нового пользователя';
        document.getElementById('userForm').reset();
        document.getElementById('deleteUserBtn').style.display = 'none';
        document.getElementById('userPasswordLabel').textContent = 'Пароль *';
        document.getElementById('userPassword').required = true;
        document.getElementById('passwordHelp').style.display = 'none';
        document.getElementById('userRole').value = 'EXECUTOR';
        userModal.show();
    }

    function editUserFromButton(button) {
        const userId = button.getAttribute('data-user-id');
        editUser(userId);
    }

    function confirmDeleteUserFromButton(button) {
        const userId = button.getAttribute('data-user-id');
        const username = button.getAttribute('data-username');
        confirmDeleteUser(userId, username);
    }

    function editUser(userId) {
    currentUserId = userId;
    document.getElementById('userModalTitle').textContent = 'Редактирование пользователя';
    document.getElementById('deleteUserBtn').style.display = 'block';
    document.getElementById('userPasswordLabel').textContent = 'Пароль';
    document.getElementById('userPassword').required = false;
    document.getElementById('passwordHelp').style.display = 'block';

    // Загружаем данные пользователя
    fetch('/api/admin/users/' + userId)
        .then(response => {
            if (!response.ok) {
                throw new Error('Пользователь не найден');
            }
            return response.json();
        })
        .then(user => {
            document.getElementById('userId').value = user.id;
            document.getElementById('userUsername').value = user.username;
            document.getElementById('userFullName').value = user.fullName;
            document.getElementById('userEmail').value = user.email;
            document.getElementById('userRole').value = user.role;
            document.getElementById('userPassword').value = '';

            userModal.show();
        })
        .catch(error => {
            console.error('Error loading user:', error);
            alert('Ошибка при загрузке пользователя: ' + error.message);
        });
}

    function confirmDeleteUser(userId, username) {
        if (confirm('Вы уверены, что хотите удалить пользователя "' + username + '"?')) {
            deleteUser(userId);
        }
    }

    function deleteUser(userId) {
        if (!userId) {
            userId = currentUserId;
        }

        fetch('/api/admin/users/' + userId, {
            method: 'DELETE'
        })
        .then(response => {
            if (response.ok) {
                userModal.hide();
                showAlert('Пользователь успешно удален!', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                throw new Error('Ошибка при удалении');
            }
        })
        .catch(error => {
            console.error('Error deleting user:', error);
            alert('Ошибка при удалении пользователя: ' + error.message);
        });
    }

    function saveUser() {
        const formData = {
            username: document.getElementById('userUsername').value,
            fullName: document.getElementById('userFullName').value,
            email: document.getElementById('userEmail').value,
            role: document.getElementById('userRole').value,
            password: document.getElementById('userPassword').value || null
        };

        if (!formData.username.trim() || !formData.fullName.trim() || !formData.email.trim()) {
            alert('Пожалуйста, заполните все обязательные поля');
            return;
        }

        // Для создания пользователя пароль обязателен
        if (!currentUserId && (!formData.password || formData.password.trim() === '')) {
            alert('Для нового пользователя необходимо указать пароль');
            return;
        }

        const url = currentUserId ? '/api/admin/users/' + currentUserId : '/api/admin/users';
        const method = currentUserId ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                return response.json().then(error => {
                    throw new Error(error.message || 'Ошибка сервера');
                });
            }
        })
        .then(data => {
            userModal.hide();
            showAlert('Пользователь успешно сохранен!', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        })
        .catch(error => {
            console.error('Error saving user:', error);
            alert('Ошибка при сохранении пользователя: ' + error.message);
        });
    }

    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-' + type + ' alert-dismissible fade show';
        alertDiv.innerHTML = message +
            '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';

        document.querySelector('.container').prepend(alertDiv);

        setTimeout(() => {
            alertDiv.remove();
        }, 3000);
    }
</script>
</body>
</html>